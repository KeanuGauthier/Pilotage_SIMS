import csv
import requests
from typing import Any, Dict, Iterable, List, Optional

USERS_LIST_METHOD = "users.list"
USER_DISABLE_METHOD = "users.disable"

class WimiClient:
    def __init__(
        self,
        base_url: str,
        token: str,
        timeout_s: int = 30,
        verify_tls: bool = True,
    ):
        self.base_url = base_url.rstrip("/")
        self.session = requests.Session()
        self.session.headers.update(
            {
                "Authorization": f"Bearer {token}",
                "Content-Type": "application/json",
                "Accept": "application/json",
            }
        )
        self.timeout_s = timeout_s
        self.verify_tls = verify_tls

    def call(self, method: str, params: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        payload = {
            "method": method,
            "params": params or {},
        }
        r = self.session.post(
            self.base_url,
            json=payload,
            timeout=self.timeout_s,
            verify=self.verify_tls,
        )
        r.raise_for_status()
        data = r.json()
        if isinstance(data, dict) and data.get("error"):
            raise RuntimeError(f"Wimi API error: {data['error']}")
        return data

def export_users_csv(
    client: WimiClient,
    csv_path: str,
    extra_params: Optional[Dict[str, Any]] = None,
    fieldnames: Optional[List[str]] = None,
) -> int:
    data = client.call(USERS_LIST_METHOD, params=extra_params or {})
    users = data.get("result", data.get("users", data))
    if not isinstance(users, list):
        raise RuntimeError(f"Unexpected users payload shape: {type(users)}")

    default_fields = [
        "id",
        "role",
        "last_name",
        "first_name",
        "email",
        "title",
        "organization",
        "status",
    ]
    cols = fieldnames or default_fields

    def pick(u: Dict[str, Any], k: str) -> Any:
        return u.get(k)

    with open(csv_path, "w", newline="", encoding="utf-8") as f:
        w = csv.DictWriter(f, fieldnames=cols)
        w.writeheader()
        for u in users:
            if not isinstance(u, dict):
                continue
            row = {k: pick(u, k) for k in cols}
            w.writerow(row)

    return len(users)

def disable_user(
    client: WimiClient,
    user_id: Optional[str] = None,
    email: Optional[str] = None,
    extra_params: Optional[Dict[str, Any]] = None,
) -> Dict[str, Any]:
    if not user_id and not email:
        raise ValueError("Provide user_id or email")

    params: Dict[str, Any] = {}
    if user_id:
        params["user_id"] = user_id
    if email:
        params["email"] = email
    if extra_params:
        params.update(extra_params)

    return client.call(USER_DISABLE_METHOD, params=params)

# Exemple dâ€™utilisation:
# client = WimiClient(base_url="https://api.wimi.pro", token="TON_TOKEN", verify_tls=False)  # intranet avec CA interne: adapte verify_tls
# n = export_users_csv(client, "users.csv")
# disable_user(client, user_id="12345")